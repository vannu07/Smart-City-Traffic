<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart City Traffic Management Dashboard</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
    <!-- Configuration from Backend -->
    <script>
        window.DASHBOARD_CONFIG = {{ config | tojsonfilter | safe }};
        window.API_CONFIG = {{ api_config | tojsonfilter | safe }};
    </script>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-traffic-light"></i>
                <h1>Smart City Traffic Management</h1>
            </div>
            <div class="status-indicator">
                <span class="status-dot" id="connectionStatus"></span>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="dashboard-main">
        <!-- Control Panel -->
        <section class="control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-route"></i> Route Optimizer</h2>
            </div>
            <div class="route-controls">
                <div class="input-group">
                    <label for="startLocation">Start Location:</label>
                    <select id="startLocation">
                        <option value="A">Point A (Main Street)</option>
                        <option value="B">Point B (Madison Ave)</option>
                        <option value="C">Point C (Park Avenue)</option>
                        <option value="D">Point D (Houston St)</option>
                        <option value="Main Street">Main Street</option>
                        <option value="Broadway">Broadway</option>
                        <option value="Park Avenue">Park Avenue</option>
                        <option value="5th Avenue">5th Avenue</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="endLocation">End Location:</label>
                    <select id="endLocation">
                        <option value="B">Point B (Madison Ave)</option>
                        <option value="A">Point A (Main Street)</option>
                        <option value="C">Point C (Park Avenue)</option>
                        <option value="D">Point D (Houston St)</option>
                        <option value="Main Street">Main Street</option>
                        <option value="Broadway">Broadway</option>
                        <option value="Park Avenue">Park Avenue</option>
                        <option value="5th Avenue">5th Avenue</option>
                    </select>
                </div>
                <button id="findRouteBtn" class="btn-primary">
                    <i class="fas fa-search"></i> Find Optimal Route
                </button>
            </div>
            <div id="routeInfo" class="route-info hidden">
                <h3>Route Information</h3>
                <div class="route-stats">
                    <div class="stat">
                        <span class="stat-label">Distance:</span>
                        <span id="routeDistance">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Est. Time:</span>
                        <span id="routeTime">-</span>
                    </div>
                </div>
            </div>
            
            <!-- API Configuration Info -->
            <div class="api-info" style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">
                <h4 style="margin-bottom: 0.5rem; color: #333;">Data Sources</h4>
                {% for api_name, api_info in api_config.items() %}
                <div style="margin-bottom: 0.5rem;">
                    <span style="font-weight: 600;">{{ api_name.replace('_', ' ').title() }}:</span>
                    {% if api_info.enabled %}
                        <span style="color: #2ed573;">✓ Active</span>
                    {% else %}
                        <span style="color: #666;">○ Available</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Map Container -->
        <section class="map-container">
            <div class="map-header">
                <h2><i class="fas fa-map"></i> Live Traffic Map</h2>
                <div class="map-controls">
                    <button id="refreshBtn" class="btn-secondary">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <div class="auto-refresh">
                        <input type="checkbox" id="autoRefresh" checked>
                        <label for="autoRefresh">Auto-refresh ({{ (config.auto_refresh_interval / 1000) | int }}s)</label>
                    </div>
                </div>
            </div>
            <div id="map" class="map"></div>
            <div class="map-legend">
                <h4>Traffic Levels</h4>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-color low"></span>
                        <span>Low Congestion</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color medium"></span>
                        <span>Medium Congestion</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color high"></span>
                        <span>High Congestion</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color anomaly"></span>
                        <span>Anomaly Alert</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Statistics Panel -->
        <section class="stats-panel">
            <div class="panel-header">
                <h2><i class="fas fa-chart-bar"></i> Traffic Statistics</h2>
            </div>
            
            <!-- Key Metrics -->
            <div class="key-metrics">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="totalVehicles">-</div>
                        <div class="metric-label">Total Vehicles</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="avgCongestion">-</div>
                        <div class="metric-label">Avg Congestion</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="anomalyCount">-</div>
                        <div class="metric-label">Anomalies</div>
                    </div>
                </div>
            </div>

            <!-- Charts Container -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Congestion Distribution</h3>
                    <canvas id="congestionChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Traffic Trend</h3>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Traffic Table -->
            <div class="traffic-table-container">
                <h3>Current Traffic Status</h3>
                <div class="table-wrapper">
                    <table id="trafficTable" class="traffic-table">
                        <thead>
                            <tr>
                                <th>Road Name</th>
                                <th>Vehicles</th>
                                <th>Congestion</th>
                                <th>Level</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="trafficTableBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Alerts Panel -->
        <section class="alerts-panel">
            <div class="panel-header">
                <h2><i class="fas fa-bell"></i> Traffic Alerts</h2>
            </div>
            <div id="alertsContainer" class="alerts-container">
                <!-- Dynamic alerts -->
            </div>
        </section>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading traffic data...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>